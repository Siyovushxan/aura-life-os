<!DOCTYPE html>
<html>
<body>
    <img id="source" src="/source_logo.jpg" style="display:none;" onload="processImage()" />
    <div id="output">Processing...</div>

    <script>
        function processImage() {
            const img = document.getElementById('source');
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            canvas.width = img.width;
            canvas.height = img.height;
            
            // Draw original image
            ctx.drawImage(img, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // 1. Circular Mask & Black Removal
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            // Radius: simpler logic, loop from center out to find edge? 
            // Or just assume the user image IS the logo centered.
            // Let's use a radius that covers the image but leaves corners.
            const radius = Math.min(centerX, centerY) * 0.98; // Slightly smaller to cut edge artifacts

            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    const index = (y * canvas.width + x) * 4;
                    const r = data[index];
                    const g = data[index + 1];
                    const b = data[index + 2];

                    // Distance from center
                    const dist = Math.sqrt((x - centerX) ** 2 + (y - centerY) ** 2);

                    // Condition 1: Outside Circle -> Transparent
                    if (dist > radius) {
                        data[index + 3] = 0; // Alpha 0
                    }
                    // Condition 2: Deep darker background pixels INSIDE circle (if any)
                    // The user image looks like a square with a logo in it.
                    // The logo reaches the edges of the circle?
                    // Let's rely on the circular mask primarily for the outer square.
                    // If the square creates corners, the mask cuts them.
                    
                    // Also simple black keying for safety inside the circle if needed?
                    // User said "remove background".
                    // If I look at the requested image, it's a logo in a dark square.
                    // If I cut a circle, I get the logo, but maybe some black border remains?
                    // Let's also do color keying: if pixel is very dark, make transparent?
                    // BUT the logo itself uses dark colors. It's dangerous.
                    // The safest bet for a "circular logo in a square" is a perfect circular crop.
                }
            }
            
            ctx.putImageData(imageData, 0, 0);

            // 2. Auto-Crop (Trim transparent edges)
            // Scan for non-transparent pixels
            let minX = canvas.width, minY = canvas.height, maxX = 0, maxY = 0;
            for (let y = 0; y < canvas.height; y++) {
                for (let x = 0; x < canvas.width; x++) {
                    const index = (y * canvas.width + x) * 4;
                    if (data[index + 3] > 0) { // Alpha > 0
                        if (x < minX) minX = x;
                        if (x > maxX) maxX = x;
                        if (y < minY) minY = y;
                        if (y > maxY) maxY = y;
                    }
                }
            }

            // Create cropped canvas
            const cropWidth = maxX - minX + 1;
            const cropHeight = maxY - minY + 1;
            
            if (cropWidth <= 0 || cropHeight <= 0) {
                 document.getElementById('output').innerText = "ERROR: Empty Image";
                 return;
            }

            const finalCanvas = document.createElement('canvas');
            finalCanvas.width = cropWidth;
            finalCanvas.height = cropHeight;
            const finalCtx = finalCanvas.getContext('2d');

            finalCtx.drawImage(canvas, minX, minY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);

            // Output Base64
            const base64 = finalCanvas.toDataURL('image/png');
            document.getElementById('output').innerText = base64; // Put in div for reading
        }
    </script>
</body>
</html>
